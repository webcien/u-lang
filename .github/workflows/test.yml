name: Tests

on:
  push:
    branches: [ master, develop, 'feature/**' ]
  pull_request:
    branches: [ master, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: compiler/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run tests
        run: |
          cd compiler
          cargo test --release --verbose
      
      - name: Run doc tests
        run: |
          cd compiler
          cargo test --doc --release

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: compiler/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build compiler
        run: |
          cd compiler
          cargo build --release --verbose
      
      - name: Verify binary exists
        run: |
          test -f compiler/target/release/ul
          echo "Binary size: $(du -h compiler/target/release/ul | cut -f1)"

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      
      - name: Check formatting
        run: |
          cd compiler
          cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      
      - name: Run clippy
        run: |
          cd compiler
          cargo clippy --release -- -D warnings

  examples:
    name: Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      
      - name: Build compiler
        run: |
          cd compiler
          cargo build --release
      
      - name: Compile examples
        run: |
          cd /home/ubuntu/u-lang
          for file in examples/*.ul; do
            echo "Compiling $file..."
            ./compiler/target/release/ul build "$file" || exit 1
          done
      
      - name: Run examples
        run: |
          cd /home/ubuntu/u-lang
          ./hello || exit 1
          ./test_lexer || exit 1
          ./loops_while || exit 1
          ./loops_for || exit 1
          ./conditionals_if || exit 1
          ./arithmetic || exit 1
